<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Osyle Exporter</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
        background: #edebe9;
        padding: 20px;
        color: #3b3b3b;
        margin: 0;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .title {
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 4px;
      }

      .divider {
        height: 1px;
        background: #e8e1dd;
        margin: 8px 0;
      }

      .section-title {
        font-size: 12px;
        font-weight: 600;
        color: #929397;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .btn {
        width: 100%;
        padding: 14px;
        border-radius: 10px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #f5c563;
        color: #1f1f20;
      }

      .btn-primary:hover:not(:disabled) {
        background: #f0bd50;
      }

      .btn-secondary {
        background: white;
        color: #3b3b3b;
        border: 1px solid #e8e1dd;
      }

      .btn-secondary:hover:not(:disabled) {
        background: #f7f5f3;
      }

      .options {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .checkbox-item {
        background: #fff;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #e8e1dd;
      }

      .checkbox-item input {
        width: 16px;
        height: 16px;
        accent-color: #f5c563;
      }

      .checkbox-label {
        font-size: 13px;
        font-weight: 500;
      }

      .status {
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        display: none;
        text-align: center;
      }

      .status.show {
        display: block;
      }

      .status.error {
        background: rgba(255, 114, 98, 0.1);
        border: 1px solid #ff7262;
        color: #ff7262;
      }

      .status.progress {
        background: rgba(245, 197, 99, 0.15);
        border: 1px solid #f5c563;
        color: #3b3b3b;
      }

      .status.success {
        background: rgba(154, 186, 170, 0.15);
        border: 1px solid #9abaaa;
        color: #3b3b3b;
      }

      .buttons-row {
        display: flex;
        gap: 8px;
      }

      .help-text {
        font-size: 11px;
        color: #929397;
        text-align: center;
        line-height: 1.4;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="title">Osyle Exporter</div>

      <!-- Send to Osyle (Primary Action) -->
      <button id="sendToOsyleBtn" class="btn btn-primary">Send to Osyle</button>

      <div class="divider"></div>

      <!-- Export ZIP Options -->
      <div class="section-title">Or Export Locally</div>

      <div class="options">
        <label class="checkbox-item">
          <input type="checkbox" id="exportJson" checked />
          <span class="checkbox-label">figma.json</span>
        </label>

        <label class="checkbox-item">
          <input type="checkbox" id="exportPng" checked />
          <span class="checkbox-label">image.png (2x)</span>
        </label>
      </div>

      <div id="status" class="status"></div>

      <div class="buttons-row">
        <button id="cancelBtn" class="btn btn-secondary">Cancel</button>
        <button id="exportBtn" class="btn btn-secondary">Export ZIP</button>
      </div>

      <div class="help-text">Select one frame or component to export</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
      const exportJsonCheckbox = document.getElementById("exportJson");
      const exportPngCheckbox = document.getElementById("exportPng");
      const sendToOsyleBtn = document.getElementById("sendToOsyleBtn");
      const exportBtn = document.getElementById("exportBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const status = document.getElementById("status");

      function showStatus(type, message) {
        status.className = `status show ${type}`;
        status.textContent = message;
      }

      function hideStatus() {
        status.className = "status";
      }

      // NEW: Send to Osyle
      sendToOsyleBtn.addEventListener("click", () => {
        sendToOsyleBtn.disabled = true;
        hideStatus();

        parent.postMessage({ pluginMessage: { type: "send-to-osyle" } }, "*");
      });

      // Export ZIP
      exportBtn.addEventListener("click", () => {
        const exportJson = exportJsonCheckbox.checked;
        const exportPng = exportPngCheckbox.checked;

        if (!exportJson && !exportPng) {
          showStatus("error", "Select at least one export option");
          return;
        }

        exportBtn.disabled = true;
        hideStatus();

        parent.postMessage(
          { pluginMessage: { type: "export", exportJson, exportPng } },
          "*"
        );
      });

      // Cancel
      cancelBtn.addEventListener("click", () => {
        parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
      });

      // Handle messages from plugin code
      window.onmessage = async (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        switch (msg.type) {
          case "progress":
            showStatus("progress", msg.message);
            break;

          case "send-to-osyle-data":
            handleSendToOsyle(msg);
            break;

          case "files-ready":
            await handleFilesReady(msg);
            break;

          case "export-complete":
            exportBtn.disabled = false;
            break;

          case "error":
            showStatus("error", msg.message);
            sendToOsyleBtn.disabled = false;
            exportBtn.disabled = false;
            break;
        }
      };

      // NEW: Forward data to React app
      function handleSendToOsyle(msg) {
        const { fileKey, nodeId, fileName } = msg;

        showStatus("success", "Sent to Osyle! Closing plugin...");

        // Forward to React app via window.opener
        if (window.opener) {
          window.opener.postMessage(
            {
              type: "FIGMA_EXPORT_DATA",
              fileKey: fileKey,
              nodeId: nodeId,
              fileName: fileName,
            },
            "*" // In production, restrict to your domain
          );

          // Close plugin after short delay
          setTimeout(() => {
            parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
          }, 1500);
        } else {
          showStatus(
            "error",
            "Could not connect to Osyle. Please open Figma via the 'Connect to Figma' button in Osyle."
          );
          sendToOsyleBtn.disabled = false;
        }
      }

      // Create and download ZIP file
      async function handleFilesReady(msg) {
        const { nodeName, timestamp, files } = msg;

        try {
          const zip = new JSZip();
          const folder = zip.folder(`${nodeName}_${timestamp}`);

          for (let i = 0; i < files.length; i++) {
            folder.file(files[i].name, new Uint8Array(files[i].content));
            showStatus(
              "progress",
              `Creating ZIP... ${Math.round(((i + 1) / files.length) * 100)}%`
            );
            await new Promise((r) => setTimeout(r, 50));
          }

          const blob = await zip.generateAsync({ type: "blob" });

          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `${nodeName}.zip`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          showStatus("success", "Download complete!");
        } catch (e) {
          showStatus("error", "Failed to create ZIP");
          console.error(e);
        }
      }
    </script>
  </body>
</html>
